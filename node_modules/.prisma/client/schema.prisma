// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

// Note that some adapters may set a maximum length for the String type by default, please ensure your strings are long
// enough when changing adapters.
// See https://www.prisma.io/docs/orm/reference/prisma-schema-reference#string for more information
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Session {
  id                  String    @id
  shop                String
  state               String
  isOnline            Boolean   @default(false)
  scope               String?
  expires             DateTime?
  accessToken         String
  userId              BigInt?
  firstName           String?
  lastName            String?
  email               String?
  accountOwner        Boolean   @default(false)
  locale              String?
  collaborator        Boolean?  @default(false)
  emailVerified       Boolean?  @default(false)
  refreshToken        String?
  refreshTokenExpires DateTime?

  @@map("session")
}

model SeoJob {
  id          String    @id
  shop        String
  createdAt   DateTime  @default(now())
  startedAt   DateTime?
  finishedAt  DateTime?
  status      String    @default("queued") // queued | running | success | failed
  total       Int       @default(0)
  okCount     Int       @default(0)
  failedCount Int       @default(0)

  // Job type
  // - PRODUCT_SEO: product meta title/description
  // - ALT_TEXT_IMAGES: image alt text generation
  jobType String @default("PRODUCT_SEO")

  metaTitle       Boolean @default(true)
  metaDescription Boolean @default(true)

  language     String  @default("tr")
  settingsJson String?
  lastError    String?

  // Phase B
  phase              String    @default("generating") // generating | generated | publishing | published
  publishOkCount     Int       @default(0)
  publishFailedCount Int       @default(0)
  publishStartedAt   DateTime?
  publishFinishedAt  DateTime?

  // Worker lock
  lockOwner     String?
  lockExpiresAt DateTime?

  items         SeoJobItem[]
  // Free plan usage reservation
  usageReserved Boolean      @default(false)
  usageCount    Int          @default(0)

  // Telemetry
  totalAttempts    Int @default(0)
  totalRetryWaitMs Int @default(0)

  // Heartbeat (worker liveness)
  // Updated periodically while a job is being processed so we can detect stuck jobs reliably.
  lastHeartbeatAt DateTime?
}

model SeoJobItem {
  id    String @id @default(cuid())
  jobId String
  job   SeoJob @relation(fields: [jobId], references: [id], onDelete: Cascade)

  // Generic target
  // PRODUCT: targetId == productId
  // IMAGE:   targetId == mediaId
  targetType String  @default("PRODUCT")
  targetId   String?

  // Parent product context (required for PRODUCT items, optional for IMAGE items but we set it)
  productId    String?
  productTitle String?

  // Image context (for IMAGE items)
  mediaId  String?
  imageUrl String?

  status         String  @default("queued") // queued | running | success | failed
  seoTitle       String?
  seoDescription String?
  error          String?

  startedAt  DateTime?
  finishedAt DateTime?

  // ✅ EKLE (Publish ayrı takip)
  publishStatus      String    @default("queued") // queued | running | success | failed
  publishError       String?
  publishedAt        DateTime?
  // Telemetry
  genAttempts        Int       @default(0)
  genRetryWaitMs     Int       @default(0)
  publishAttempts    Int       @default(0)
  publishRetryWaitMs Int       @default(0)

  @@unique([jobId, targetType, targetId])
  @@index([jobId])
}

// --- Mock Billing (dev/private apps) ---
// Shopify Billing API cannot be used unless the app has public distribution.
// This table lets us simulate an active subscription during development.
model BillingSubscription {
  shop        String    @id
  plan        String
  status      String    @default("active") // active | cancelled
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  cancelledAt DateTime?
}

// --- Free plan usage (monthly) ---
// Free plan limits are counted per shop per calendar month.
// We count "products processed" (number of productIds sent to generation).
model FreePlanUsageMonthly {
  shop  String
  month String // YYYY-MM (UTC)
  used  Int    @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@id([shop, month])
}
